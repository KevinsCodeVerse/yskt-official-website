{"ast":null,"code":"import \"core-js/modules/es.symbol.js\";\nimport \"core-js/modules/es.symbol.description.js\";\nimport \"core-js/modules/es.symbol.iterator.js\";\nimport \"core-js/modules/es.error.cause.js\";\nimport \"core-js/modules/es.error.to-string.js\";\nimport \"core-js/modules/es.array.for-each.js\";\nimport \"core-js/modules/es.array.push.js\";\nimport \"core-js/modules/es.date.to-string.js\";\nimport \"core-js/modules/es.object.create.js\";\nimport \"core-js/modules/es.object.keys.js\";\nimport \"core-js/modules/es.object.proto.js\";\nimport \"core-js/modules/es.object.set-prototype-of.js\";\nimport \"core-js/modules/es.object.to-string.js\";\nimport \"core-js/modules/es.regexp.to-string.js\";\nimport \"core-js/modules/es.string.iterator.js\";\nimport \"core-js/modules/web.dom-collections.for-each.js\";\nimport \"core-js/modules/web.dom-collections.iterator.js\";\nvar __extends = this && this.__extends || function () {\n  var _extendStatics = function extendStatics(d, b) {\n    _extendStatics = Object.setPrototypeOf || {\n      __proto__: []\n    } instanceof Array && function (d, b) {\n      d.__proto__ = b;\n    } || function (d, b) {\n      for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];\n    };\n    return _extendStatics(d, b);\n  };\n  return function (d, b) {\n    _extendStatics(d, b);\n    function __() {\n      this.constructor = d;\n    }\n    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n  };\n}();\nvar __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  function adopt(value) {\n    return value instanceof P ? value : new P(function (resolve) {\n      resolve(value);\n    });\n  }\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n    function step(result) {\n      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n    }\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\nvar __generator = this && this.__generator || function (thisArg, body) {\n  var _ = {\n      label: 0,\n      sent: function sent() {\n        if (t[0] & 1) throw t[1];\n        return t[1];\n      },\n      trys: [],\n      ops: []\n    },\n    f,\n    y,\n    t,\n    g;\n  return g = {\n    next: verb(0),\n    \"throw\": verb(1),\n    \"return\": verb(2)\n  }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function () {\n    return this;\n  }), g;\n  function verb(n) {\n    return function (v) {\n      return step([n, v]);\n    };\n  }\n  function step(op) {\n    if (f) throw new TypeError(\"Generator is already executing.\");\n    while (_) try {\n      if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\n      if (y = 0, t) op = [op[0] & 2, t.value];\n      switch (op[0]) {\n        case 0:\n        case 1:\n          t = op;\n          break;\n        case 4:\n          _.label++;\n          return {\n            value: op[1],\n            done: false\n          };\n        case 5:\n          _.label++;\n          y = op[1];\n          op = [0];\n          continue;\n        case 7:\n          op = _.ops.pop();\n          _.trys.pop();\n          continue;\n        default:\n          if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) {\n            _ = 0;\n            continue;\n          }\n          if (op[0] === 3 && (!t || op[1] > t[0] && op[1] < t[3])) {\n            _.label = op[1];\n            break;\n          }\n          if (op[0] === 6 && _.label < t[1]) {\n            _.label = t[1];\n            t = op;\n            break;\n          }\n          if (t && _.label < t[2]) {\n            _.label = t[2];\n            _.ops.push(op);\n            break;\n          }\n          if (t[2]) _.ops.pop();\n          _.trys.pop();\n          continue;\n      }\n      op = body.call(thisArg, _);\n    } catch (e) {\n      op = [6, e];\n      y = 0;\n    } finally {\n      f = t = 0;\n    }\n    if (op[0] & 5) throw op[1];\n    return {\n      value: op[0] ? op[1] : void 0,\n      done: true\n    };\n  }\n};\nimport { CRC32 } from '../utils/crc32';\nimport { direct } from '../api';\nimport Base from './base';\nvar Direct = /** @class */function (_super) {\n  __extends(Direct, _super);\n  function Direct() {\n    return _super !== null && _super.apply(this, arguments) || this;\n  }\n  Direct.prototype.run = function () {\n    return __awaiter(this, void 0, void 0, function () {\n      var formData, crcSign, customVars_1, metadata_1, result;\n      var _this = this;\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            this.logger.info('start run Direct.');\n            formData = new FormData();\n            formData.append('file', this.file);\n            formData.append('token', this.token);\n            if (this.key != null) {\n              formData.append('key', this.key);\n            }\n            formData.append('fname', this.putExtra.fname);\n            if (!this.config.checkByServer) return [3 /*break*/, 2];\n            return [4 /*yield*/, CRC32.file(this.file)];\n          case 1:\n            crcSign = _a.sent();\n            formData.append('crc32', crcSign.toString());\n            _a.label = 2;\n          case 2:\n            if (this.putExtra.customVars) {\n              this.logger.info('init customVars.');\n              customVars_1 = this.putExtra.customVars;\n              Object.keys(customVars_1).forEach(function (key) {\n                return formData.append(key, customVars_1[key].toString());\n              });\n              this.logger.info('customVars inited.');\n            }\n            if (this.putExtra.metadata) {\n              this.logger.info('init metadata.');\n              metadata_1 = this.putExtra.metadata;\n              Object.keys(metadata_1).forEach(function (key) {\n                return formData.append(key, metadata_1[key].toString());\n              });\n            }\n            this.logger.info('formData inited.');\n            return [4 /*yield*/, direct(this.uploadHost.getUrl(), formData, {\n              onProgress: function onProgress(data) {\n                _this.updateDirectProgress(data.loaded, data.total);\n              },\n              onCreate: function onCreate(xhr) {\n                return _this.addXhr(xhr);\n              }\n            })];\n          case 3:\n            result = _a.sent();\n            this.logger.info('Direct progress finish.');\n            this.finishDirectProgress();\n            return [2 /*return*/, result];\n        }\n      });\n    });\n  };\n  Direct.prototype.updateDirectProgress = function (loaded, total) {\n    // 当请求未完成时可能进度会达到100，所以total + 1来防止这种情况出现\n    this.progress = {\n      total: this.getProgressInfoItem(loaded, total + 1)\n    };\n    this.onData(this.progress);\n  };\n  Direct.prototype.finishDirectProgress = function () {\n    // 在某些浏览器环境下，xhr 的 progress 事件无法被触发，progress 为 null，这里 fake 下\n    if (!this.progress) {\n      this.logger.warn('progress is null.');\n      this.progress = {\n        total: this.getProgressInfoItem(this.file.size, this.file.size)\n      };\n      this.onData(this.progress);\n      return;\n    }\n    var total = this.progress.total;\n    this.progress = {\n      total: this.getProgressInfoItem(total.loaded + 1, total.size)\n    };\n    this.onData(this.progress);\n  };\n  return Direct;\n}(Base);\nexport default Direct;","map":{"version":3,"names":["CRC32","direct","Base","Direct","_super","__extends","prototype","run","logger","info","formData","FormData","append","file","token","key","putExtra","fname","config","checkByServer","crcSign","_a","sent","toString","customVars","customVars_1","Object","keys","forEach","metadata","metadata_1","uploadHost","getUrl","onProgress","data","_this","updateDirectProgress","loaded","total","onCreate","xhr","addXhr","result","finishDirectProgress","progress","getProgressInfoItem","onData","warn","size"],"sources":["../../src/upload/direct.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}